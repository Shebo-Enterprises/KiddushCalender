<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KiddushWare Admin</title>
    <!-- Bootstrap 3 CSS (Kept for compatibility) -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* APPLE DESIGN OVERRIDES */
        :root {
            --apple-blue: #0071e3;
            --apple-bg: #f5f5f7;
            --apple-text: #1d1d1f;
            --apple-secondary: #86868b;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: #ffffff;
            color: var(--apple-text);
            -webkit-font-smoothing: antialiased;
        }

        /* Nav & Header Styling */
        header {
            background: rgba(255, 255, 255, 0.8) !important;
            backdrop-filter: saturate(180%) blur(20px);
            border-bottom: 1px solid rgba(0,0,0,0.1) !important;
        }

        .navbar-brand {
            font-weight: 700;
            letter-spacing: -0.5px;
            color: var(--apple-text) !important;
        }

        /* Sidebar Styling */
        .sidebar {
            background-color: var(--apple-bg) !important;
            border-right: 1px solid rgba(0,0,0,0.05) !important;
            width: 250px;
            padding-top: 30px;
        }

        .sidebar ul li a {
            padding: 12px 25px;
            color: var(--apple-secondary);
            font-weight: 500;
            transition: all 0.2s;
            border-radius: 0 20px 20px 0;
            margin-right: 15px;
        }

        .sidebar ul li a:hover, .sidebar ul li a.active {
            background-color: rgba(0,0,0,0.05);
            color: var(--apple-text);
            text-decoration: none;
        }

        /* Cards & Containers */
        .admin-content {
            padding: 40px;
            animation: reveal 0.6s ease-out;
        }

        .well, .panel, .config-item {
            background: #ffffff !important;
            border: 1px solid rgba(0,0,0,0.05) !important;
            border-radius: 18px !important;
            box-shadow: 0 4px 12px rgba(0,0,0,0.03) !important;
            padding: 25px !important;
        }

        /* Button Styling */
        .btn-primary {
            background-color: var(--apple-blue) !important;
            border: none !important;
            border-radius: 20px !important;
            padding: 8px 20px !important;
            font-weight: 500 !important;
            transition: opacity 0.2s;
        }

        .btn-primary:hover { opacity: 0.85; }

        .btn-danger {
            background-color: #ff3b30 !important;
            border-radius: 20px !important;
            border: none !important;
        }

        /* Inputs */
        .form-control {
            border-radius: 10px !important;
            border: 1px solid #d2d2d7 !important;
            box-shadow: none !important;
            height: 40px;
        }

        .form-control:focus {
            border-color: var(--apple-blue) !important;
        }

        /* Global Helpers */
        .hidden { display: none !important; }
        
        @keyframes reveal {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        h2, h3 {
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        .embed-code {
            background-color: var(--apple-bg);
            border-radius: 8px;
            padding: 15px;
            font-family: 'SFMono-Regular', Consolas, monospace;
            font-size: 13px;
        }

        /* Support Banner */
        .support-banner {
            background: var(--apple-blue);
            color: white;
            text-align: center;
            padding: 10px;
            font-size: 14px;
            border-radius: 12px;
            margin-bottom: 30px;
        }
    </style>
</head>
<body>

<header class="navbar navbar-static-top">
    <div class="container-fluid">
        <div class="navbar-header">
            <a class="navbar-brand" href="#">KiddushWare</a>
        </div>
        <div id="user-info" class="navbar-right hidden" style="padding-right: 20px; line-height: 50px;">
            <span id="user-email" style="margin-right: 15px; color: #86868b;"></span>
            <button id="logout-btn" class="btn btn-link" style="color: var(--apple-blue); padding: 0;">Sign Out</button>
        </div>
    </div>
</header>

<div id="auth-view" class="container" style="margin-top: 100px;">
    <div class="row">
        <div class="col-md-4 col-md-offset-4 text-center">
            <h2 style="font-size: 32px; margin-bottom: 10px;">Sign in to Admin</h2>
            <p style="color: #86868b; margin-bottom: 30px;">Enter your credentials to manage your shul.</p>
            <div class="well">
                <form id="login-form">
                    <div class="form-group">
                        <input type="email" id="email" class="form-control" placeholder="Email" required>
                    </div>
                    <div class="form-group">
                        <input type="password" id="password" class="form-control" placeholder="Password" required>
                    </div>
                    <button type="submit" class="btn btn-primary btn-block" style="height: 44px; font-size: 16px;">Sign In</button>
                </form>
                <hr>
                <button id="google-login" class="btn btn-default btn-block" style="border-radius: 20px;">
                    <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="18" style="margin-right: 8px;"> 
                    Sign in with Google
                </button>
            </div>
        </div>
    </div>
</div>

<div id="admin-view" class="admin-container hidden">
    <!-- SIDEBAR -->
    <div class="sidebar">
        <ul class="nav">
            <li><a href="#" class="active" onclick="showSection('dashboard')">Dashboard</a></li>
            <li><a href="#" onclick="showSection('configs')">Configurations</a></li>
            <li><a href="#" onclick="showSection('events')">Custom Events</a></li>
            <li><a href="#" onclick="showSection('reserve')">Internal Reserve</a></li>
            <li><a href="#" onclick="showSection('sponsorships')">Sponsorships</a></li>
            <li><a href="#" onclick="showSection('support')">Support & Tutorials</a></li>
        </ul>
    </div>

    <!-- MAIN CONTENT -->
    <div class="admin-content" style="flex: 1; margin-left: 250px;">
        
        <div class="support-banner">
            Need help? Visit our <a href="https://kiddushware.tawk.help/" target="_blank" style="color: white; text-decoration: underline;">Knowledge Base</a>
        </div>

        <!-- Dashboard Section -->
        <div id="section-dashboard" class="section-content">
            <h2 class="page-header" style="border: none;">Dashboard</h2>
            <div class="row">
                <div class="col-md-6">
                    <div class="well">
                        <h3 style="margin-top: 0;">Welcome back</h3>
                        <p>Manage your shul's kiddush sponsorships and configurations easily from here.</p>
                        <p>Total Sponsorships in Database: <strong id="total-sponsorships-count">0</strong></p>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="well" style="background-color: var(--apple-text) !important; color: white;">
                        <h3 style="margin-top: 0; color: white;">Quick Tip</h3>
                        <p style="color: #a1a1a6;">Use the "Custom Events" tab to add special dates like Bar Mitzvahs or Communal Luncheons.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Configurations Section -->
        <div id="section-configs" class="section-content hidden">
            <div class="row">
                <div class="col-md-12">
                    <h2 class="page-header" style="border: none; display: flex; justify-content: space-between; align-items: center;">
                        Configurations
                        <button class="btn btn-primary" data-toggle="modal" data-target="#configModal">New Configuration</button>
                    </h2>
                    <div id="config-list">
                        <!-- Config items will be loaded here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Custom Events Section -->
        <div id="section-events" class="section-content hidden">
            <h2 class="page-header" style="border: none;">Custom Events</h2>
            <div class="row">
                <div class="col-md-4">
                    <div class="well">
                        <h4>Add Event</h4>
                        <form id="create-event-form">
                            <div class="form-group"><input type="text" id="event-title" class="form-control" placeholder="Event Title" required></div>
                            <div class="form-group"><textarea id="event-description" class="form-control" placeholder="Description"></textarea></div>
                            <div class="form-group"><label>Start Date</label><input type="date" id="event-start-date" class="form-control" required></div>
                            <div class="form-group"><label>End Date</label><input type="date" id="event-end-date" class="form-control" required></div>
                            <button type="submit" class="btn btn-primary btn-block">Create Event</button>
                        </form>
                    </div>
                </div>
                <div class="col-md-8">
                    <div id="events-list"></div>
                </div>
            </div>
        </div>

        <!-- Internal Reserve Section -->
        <div id="section-reserve" class="section-content hidden">
            <h2 class="page-header" style="border: none;">Internal Reservation</h2>
            <div class="well" style="max-width: 600px; margin: 0 auto;">
                <form id="internal-reserve-form">
                    <div class="form-group">
                        <label>Select Target</label>
                        <select id="reserve-type" class="form-control">
                            <option value="shabbat">Shabbat / Parsha</option>
                            <option value="custom">Custom Event</option>
                        </select>
                    </div>
                    <div id="target-selection-container" class="form-group">
                        <!-- Select will be populated dynamically -->
                    </div>
                    <div class="form-group"><input type="text" id="reserve-sponsor-name" class="form-control" placeholder="Sponsor Name" required></div>
                    <div class="form-group"><input type="text" id="reserve-occasion" class="form-control" placeholder="Occasion" required></div>
                    <div class="form-group"><input type="email" id="reserve-email" class="form-control" placeholder="Email (Optional)"></div>
                    <button type="submit" class="btn btn-primary btn-block">Confirm Reservation</button>
                </form>
            </div>
        </div>

        <!-- Sponsorships Section -->
        <div id="section-sponsorships" class="section-content hidden">
            <h2 class="page-header" style="border: none;">Manage Sponsorships</h2>
            <div class="row">
                <div class="col-md-6">
                    <h4 style="color: #ff9500; font-weight: 600;">Pending Approval</h4>
                    <div id="pending-sponsorships"></div>
                </div>
                <div class="col-md-6">
                    <h4 style="color: #34c759; font-weight: 600;">Approved</h4>
                    <div id="approved-sponsorships"></div>
                </div>
            </div>
        </div>

        <!-- Support Section -->
        <div id="section-support" class="section-content hidden">
            <h2 class="page-header" style="border: none;">Tutorials</h2>
            <div class="well">
                <div style="padding:56.25% 0 0 0;position:relative;">
                    <iframe src="https://fast.wistia.net/embed/iframe/dgq1pg5kwp?videoFoam=true" title="Tutorial" allow="autoplay; fullscreen" allowtransparency="true" frameborder="0" scrolling="no" class="wistia_embed" name="wistia_embed" style="position:absolute;top:0;left:0;width:100%;height:100%;"></iframe>
                </div>
            </div>
        </div>

    </div>
</div>

<!-- Config Modal -->
<div class="modal fade" id="configModal" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content" style="border-radius: 20px;">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal">&times;</button>
        <h4 class="modal-title">New Configuration</h4>
      </div>
      <div class="modal-body">
        <form id="config-form">
            <div class="form-group"><input type="text" id="cfg-title" class="form-control" placeholder="Title (e.g. Main Shul Kiddush)" required></div>
            <div class="form-group">
                <select id="cfg-type" class="form-control">
                    <option value="form">Form Style</option>
                    <option value="calendar">Calendar Style</option>
                </select>
            </div>
            <div class="form-group"><input type="email" id="cfg-email" class="form-control" placeholder="Notification Email"></div>
            <hr>
            <h5>Stripe Integration</h5>
            <div class="row">
                <div class="col-md-6"><input type="text" id="cfg-price" class="form-control" placeholder="Price ($)"></div>
                <div class="col-md-6"><input type="text" id="cfg-link" class="form-control" placeholder="Payment Link"></div>
            </div>
            <br>
            <button type="submit" class="btn btn-primary btn-block">Save Configuration</button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- SCRIPTS -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

<script>
    // INITIALIZATION (Your Logic Starts Here)
    var firebaseConfig = { apiKey: "AIzaSyAeD0nSxWPOJaptIoxsnyHO_cq-oXW-nUg",
  authDomain: "chabadkiddushsponsor.firebaseapp.com",
  projectId: "chabadkiddushsponsor",
  storageBucket: "chabadkiddushsponsor.firebasestorage.app",
  messagingSenderId: "1061586315092",
  appId: "1:1061586315092:web:4d804725adb81a9dcfcac1",
  measurementId: "G-NLPQKVWDFZ" };
    firebase.initializeApp(firebaseConfig);
    var db = firebase.firestore();
    var auth = firebase.auth();

    // AUTH OBSERVER
    auth.onAuthStateChanged(function(user) {
        if (user) {
            $("#auth-view").addClass("hidden");
            $("#admin-view").removeClass("hidden");
            $("#user-info").removeClass("hidden");
            $("#user-email").text(user.email);
            initAdmin();
        } else {
            $("#auth-view").removeClass("hidden");
            $("#admin-view").addClass("hidden");
            $("#user-info").addClass("hidden");
        }
    });

    // LOGIN & LOGOUT
    $("#login-form").submit(function(e) {
        e.preventDefault();
        auth.signInWithEmailAndPassword($("#email").val(), $("#password").val()).catch(alert);
    });

    $("#logout-btn").click(function() { auth.signOut(); });

    $("#google-login").click(function() {
        var provider = new firebase.auth.GoogleAuthProvider();
        auth.signInWithPopup(provider).catch(alert);
    });

    // NAVIGATION
    function showSection(sectionId) {
        $(".section-content").addClass("hidden");
        $("#section-" + sectionId).removeClass("hidden");
        $(".sidebar a").removeClass("active");
        $('.sidebar a[onclick*="'+sectionId+'"]').addClass("active");
    }

    // LOAD DATA
    function initAdmin() {
        loadConfigs();
        loadEvents();
        loadSponsorships();
        populateReserveTargets();
    }

    function loadConfigs() {
        db.collection("configs").get().then(function(snap) {
            $("#config-list").empty();
            snap.forEach(function(doc) {
                var d = doc.data();
                $("#config-list").append(`
                    <div class="config-item">
                        <div class="row">
                            <div class="col-md-8">
                                <h4>${d.title} <small>${d.type}</small></h4>
                                <p>Link: <code>https://yourdomain.com/${doc.id}</code></p>
                            </div>
                            <div class="col-md-4 text-right">
                                <button class="btn btn-default btn-sm" onclick="deleteDoc('configs', '${doc.id}')">Delete</button>
                            </div>
                        </div>
                    </div>
                `);
            });
        });
    }

    function loadEvents() {
        db.collection("customEvents").get().then(function(snap) {
            $("#events-list").empty();
            snap.forEach(function(doc) {
                var d = doc.data();
                $("#events-list").append(`
                    <div class="well">
                        <h4>${d.title}</h4>
                        <p>${d.description}</p>
                        <p><small>${d.startDate} to ${d.endDate}</small></p>
                        <button class="btn btn-danger btn-xs" onclick="deleteDoc('customEvents', '${doc.id}')">Delete Event</button>
                    </div>
                `);
            });
        });
    }

    function loadSponsorships() {
        db.collection("sponsorships").get().then(function(snap) {
            $("#pending-sponsorships, #approved-sponsorships").empty();
            $("#total-sponsorships-count").text(snap.size);
            snap.forEach(function(doc) {
                var d = doc.data();
                var html = `
                    <div class="well well-sm" style="margin-bottom: 10px; border-radius: 12px;">
                        <strong>${d.sponsorName}</strong><br>
                        <small>${d.occasion}</small><br>
                        <div style="margin-top: 5px;">
                            ${d.status === 'pending' ? `<button class="btn btn-primary btn-xs" onclick="approveSponsorship('${doc.id}')">Approve</button>` : ''}
                            <button class="btn btn-default btn-xs" onclick="deleteDoc('sponsorships', '${doc.id}')">Remove</button>
                        </div>
                    </div>
                `;
                if(d.status === 'approved') $("#approved-sponsorships").append(html);
                else $("#pending-sponsorships").append(html);
            });
        });
    }

    // CRUD ACTIONS
    $("#config-form").submit(function(e) {
        e.preventDefault();
        db.collection("configs").add({
            title: $("#cfg-title").val(),
            type: $("#cfg-type").val(),
            email: $("#cfg-email").val(),
            price: $("#cfg-price").val(),
            link: $("#cfg-link").val()
        }).then(function() {
            $("#configModal").modal('hide');
            loadConfigs();
        });
    });

    $("#create-event-form").submit(function(e) {
        e.preventDefault();
        db.collection("customEvents").add({
            title: $("#event-title").val(),
            description: $("#event-description").val(),
            startDate: $("#event-start-date").val(),
            endDate: $("#event-end-date").val()
        }).then(loadEvents);
    });

    function approveSponsorship(id) {
        db.collection("sponsorships").doc(id).update({ status: 'approved' }).then(loadSponsorships);
    }

    function deleteDoc(col, id) {
        if(confirm("Are you sure?")) {
            db.collection(col).doc(id).delete().then(initAdmin);
        }
    }

    function populateReserveTargets() {
        // Mocking target list logic for brevity - usually based on your internal logic
        $("#target-selection-container").html('<select id="res-target" class="form-control"><option value="shabbat-2024-05-10">May 10: Parshat Emor</option></select>');
    }

    $("#internal-reserve-form").submit(function(e) {
        e.preventDefault();
        db.collection("sponsorships").add({
            sponsorName: $("#reserve-sponsor-name").val(),
            occasion: $("#reserve-occasion").val(),
            email: $("#reserve-email").val(),
            status: 'approved',
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        }).then(function() {
            alert("Reserved Successfully");
            loadSponsorships();
        });
    });

</script>

</body>
</html>

